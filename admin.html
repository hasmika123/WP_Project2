<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Fifteen Puzzle</title>
    <link rel="stylesheet" href="fifteen.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .admin-header {
            background: linear-gradient(135deg, var(--green-darker), var(--green-dark));
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(52, 79, 0, 0.3);
            border: 2px solid var(--green-primary);
        }

        .admin-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .admin-header p {
            margin: 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .admin-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: auto auto auto;
            gap: 25px;
            margin-bottom: 30px;
        }

        /* System Overview takes full width in first row */
        .admin-card:first-child {
            grid-column: 1 / -1;
        }

        /* Responsive layout for smaller screens */
        @media (max-width: 1200px) {
            .admin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-card:first-child {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-card:first-child {
                grid-column: 1;
            }
        }

        .admin-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(113, 179, 7, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            height: 600px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* System Overview card with auto height to fit content */
        .admin-card:first-child {
            height: auto;
            min-height: auto;
        }

        .admin-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--green-primary), var(--green-light));
        }

        .admin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--green-light);
            flex-shrink: 0;
        }

        .card-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .card-content::-webkit-scrollbar {
            width: 6px;
        }

        .card-content::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 3px;
        }

        .card-content::-webkit-scrollbar-thumb {
            background: var(--green-primary);
            border-radius: 3px;
        }

        .card-content::-webkit-scrollbar-thumb:hover {
            background: var(--green-darker);
        }

        .card-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--green-darker), var(--green-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--green-darker);
            margin: 0;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-refresh {
            background: var(--green-primary);
            color: white;
        }

        .btn-settings {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .card-action-btn:hover {
            transform: scale(1.05);
        }

        .admin-stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, var(--gray-50), white);
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .admin-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--green-darker);
            display: block;
        }

        .admin-stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-top: 5px;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .user-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--green-darker);
        }

        /* Tab Navigation Styling */
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            color: var(--gray-600);
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--green-primary);
            background: var(--gray-50);
        }

        .tab-btn.active {
            color: var(--green-primary);
            border-bottom-color: var(--green-primary);
            background: var(--gray-50);
        }

        .tab-content {
            padding: 20px 0;
        }

        .user-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.1);
            color: rgb(34, 197, 94);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: rgb(239, 68, 68);
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-admin {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-primary-admin {
            background: linear-gradient(135deg, var(--green-darker), var(--green-dark));
            color: white;
        }

        .btn-secondary-admin {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 2px solid var(--gray-200);
        }

        .btn-danger-admin {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .system-log {
            max-height: 300px;
            overflow-y: auto;
            background: var(--gray-50);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }

        .log-timestamp {
            color: var(--gray-500);
            white-space: nowrap;
        }

        .log-level {
            font-weight: 600;
            width: 60px;
        }

        .log-info {
            color: var(--green-dark);
        }

        .log-warning {
            color: #f59e0b;
        }

        .log-error {
            color: #dc3545;
        }

        .chart-placeholder {
            height: 200px;
            background: linear-gradient(135deg, var(--gray-50), white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            font-style: italic;
            border: 2px dashed var(--gray-300);
        }

        /* Action Buttons Styling */
        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            margin: 0 1px;
            transition: all 0.2s;
            min-width: 45px;
            white-space: nowrap;
        }

        .btn-edit {
            background: var(--green-primary);
            color: white;
        }

        .btn-toggle {
            background: #17a2b8;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Compact action buttons for tables */
        .action-btn-compact {
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            font-size: 0.65rem;
            cursor: pointer;
            margin: 0 1px;
            transition: all 0.2s;
            min-width: 35px;
            white-space: nowrap;
            font-weight: 500;
        }

        .btn-edit-compact {
            background: var(--green-primary);
            color: white;
        }

        .btn-toggle-compact {
            background: #17a2b8;
            color: white;
        }

        .btn-delete-compact {
            background: #dc3545;
            color: white;
        }

        .action-btn-compact:hover {
            transform: scale(1.03);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
        }

        /* Table actions column styling */
        .user-table th:last-child,
        .user-table td:last-child {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            text-align: center;
        }

        /* Background images table specific styling */
        .background-images-table {
            width: 100%;
            table-layout: fixed;
        }

        /* Reduce padding for background images table to prevent horizontal scroll */
        .background-images-table th,
        .background-images-table td {
            padding: 8px 6px;
        }

        .background-images-table th:nth-child(1),
        .background-images-table td:nth-child(1) {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: center;
        }

        .background-images-table th:nth-child(2),
        .background-images-table td:nth-child(2) {
            width: 25%;
            min-width: 90px;
        }

        .background-images-table th:nth-child(3),
        .background-images-table td:nth-child(3) {
            width: 25%;
            min-width: 90px;
            word-break: break-all;
        }

        .background-images-table th:nth-child(4),
        .background-images-table td:nth-child(4) {
            width: 15%;
            min-width: 60px;
            text-align: center;
        }

        .background-images-table th:nth-child(5),
        .background-images-table td:nth-child(5) {
            width: 15%;
            min-width: 60px;
        }

        .background-images-table th:nth-child(6),
        .background-images-table td:nth-child(6) {
            width: 90px;
            min-width: 90px;
            max-width: 90px;
            text-align: center;
        }

        /* Modal Styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 2px solid var(--green-light);
            background: linear-gradient(135deg, var(--green-darker), var(--green-dark));
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--green-darker);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--green-primary);
            box-shadow: 0 0 0 3px rgba(113, 179, 7, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }

        /* Upload Section Styling */
        .upload-section {
            background: linear-gradient(135deg, var(--gray-50), white);
            border: 2px dashed var(--green-light);
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--green-primary);
            background: linear-gradient(135deg, var(--green-light), #f0f9e6);
        }

        .upload-section h4 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-section h4::before {
            content: '📤';
            font-size: 1.2rem;
        }

        /* Image Preview Styles */
        .image-preview-container {
            position: relative;
            display: inline-block;
        }

        .image-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 4px;
            cursor: pointer;
        }

        .image-preview-container:hover .image-preview-overlay {
            opacity: 1;
        }

        /* File Input Styling */
        input[type="file"].form-input {
            padding: 10px;
            border: 2px dashed var(--gray-300);
            background: var(--gray-50);
            cursor: pointer;
            transition: all 0.3s;
        }

        input[type="file"].form-input:hover {
            border-color: var(--green-primary);
            background: var(--green-light);
        }

        input[type="file"].form-input:focus {
            border-color: var(--green-primary);
            box-shadow: 0 0 0 3px rgba(113, 179, 7, 0.1);
        }

        /* Upload Section Enhancements */
        .upload-section .radio-option:hover {
            background: var(--gray-50) !important;
            border-color: var(--green-light) !important;
        }

        .upload-section .radio-option input[type="radio"]:checked + span {
            color: var(--green-darker);
        }

        .upload-section .checkbox-option:hover {
            background: var(--gray-50) !important;
            border-color: var(--green-light) !important;
        }

        .upload-section .file-input-container input[type="file"] {
            transition: all 0.2s ease;
        }

        .upload-section .file-input-container input[type="file"]:hover {
            border-color: var(--green-primary);
            background: var(--green-50);
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }
            
            .admin-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .admin-actions {
                flex-direction: column;
            }
            
            .admin-stat-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }

            .modal-actions {
                flex-direction: column;
            }

            .upload-section div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* Admin-only menu items - hidden by default for non-admin users */
        .admin-only {
            display: block;
        }

        .user-role-player .admin-only {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-brand">
                <h1 class="brand-title">Fifteen Puzzle</h1>
                <span class="brand-subtitle">Administration Panel</span>
            </div>
            
            <!-- User Auth -->
            <div class="header-actions">
                <div id="userPanel" class="auth-user">
                    <div class="user-menu">
                        <button class="user-avatar" id="userMenuToggle">
                            <span id="userInitials">A</span>
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="user-info">
                                <div class="user-name" id="userName">Admin</div>
                                <div class="user-role" id="userRole">Administrator</div>
                            </div>
                            <button class="dropdown-item admin-only" id="adminDashboardItem">
                                <span class="item-icon">�️</span>
                                Admin Dashboard
                            </button>
                            <button class="dropdown-item" onclick="window.location.href='dashboard.html'">
                                <span class="item-icon">📋</span>
                                Player Dashboard
                            </button>
                            <button class="dropdown-item" onclick="window.location.href='fifteen.html'">
                                <span class="item-icon">🎮</span>
                                Play Game
                            </button>
                            <hr class="dropdown-divider">
                            <button class="dropdown-item" id="logoutButton">
                                <span class="item-icon">🚪</span>
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="admin-container">
        <div class="admin-header">
            <h1>🛠️ Admin Dashboard</h1>
            <p>Manage users, configure game settings, and monitor game analytics</p>
            <span class="admin-badge">Administrator Access</span>
        </div>

        <div class="admin-grid">
            <!-- System Overview -->
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title-section">
                        <div class="card-icon">📊</div>
                        <h2 class="card-title">System Overview</h2>
                    </div>
                </div>
                <div class="card-content">
                    <div class="admin-stat-grid">
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="totalUsers">0</span>
                            <div class="admin-stat-label">Total Users</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="activeUsers">0</span>
                            <div class="admin-stat-label">Active Users</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="totalGamesPlayed">0</span>
                            <div class="admin-stat-label">Games Played</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Analytics -->
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title-section">
                        <div class="card-icon">🎯</div>
                        <h2 class="card-title">Game Statistics Monitoring</h2>
                    </div>
                </div>
                
                <div class="card-content">
                    <!-- Aggregate Statistics -->
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--green-darker);">📊 Aggregate Game Statistics</h4>
                    <div class="admin-stat-grid">
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="totalGamesPlayed">0</span>
                            <div class="admin-stat-label">Total Games</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="totalPlayersActive">0</span>
                            <div class="admin-stat-label">Active Players</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="avgCompletionTime">--</span>
                            <div class="admin-stat-label">Avg Time</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="avgMoves">--</span>
                            <div class="admin-stat-label">Avg Moves</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="completionRate">--</span>
                            <div class="admin-stat-label">Completion Rate</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="mostPopularPuzzle">--</span>
                            <div class="admin-stat-label">Popular Puzzle</div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Tabs -->
                <div style="margin-bottom: 20px;">
                    <div class="tab-navigation" style="display: flex; border-bottom: 2px solid var(--gray-200);">
                        <button class="tab-btn active" onclick="showTab('leaderboard')" id="leaderboardTab">
                            🏆 Top Players
                        </button>
                        <button class="tab-btn" onclick="showTab('individual')" id="individualTab">
                            👤 Individual Stats
                        </button>
                        <button class="tab-btn" onclick="showTab('detailed')" id="detailedTab">
                            📈 Detailed Analytics
                        </button>
                    </div>
                </div>

                <!-- Leaderboard Tab -->
                <div id="leaderboardContent" class="tab-content" style="display: block;">
                    <h4 style="margin: 0 0 15px 0; color: var(--green-darker);">🏆 Top Players Leaderboard</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Best Time</th>
                                    <th>Games Won</th>
                                    <th>Win Rate</th>
                                    <th>Avg Moves</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardTableBody">
                                <!-- Leaderboard data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Individual Player Stats Tab -->
                <div id="individualContent" class="tab-content" style="display: none;">
                    <h4 style="margin: 0 0 15px 0; color: var(--green-darker);">👤 Individual Player Statistics</h4>
                    <div style="margin-bottom: 15px;">
                        <select id="playerSelector" class="form-input" style="width: 300px;" onchange="loadPlayerStats()">
                            <option value="">Select a player...</option>
                        </select>
                    </div>
                    <div id="playerStatsContent" style="display: none;">
                        <div class="admin-stat-grid" style="margin-bottom: 20px;">
                            <div class="admin-stat-item">
                                <span class="admin-stat-value" id="playerTotalGames">0</span>
                                <div class="admin-stat-label">Total Games</div>
                            </div>
                            <div class="admin-stat-item">
                                <span class="admin-stat-value" id="playerGamesWon">0</span>
                                <div class="admin-stat-label">Games Won</div>
                            </div>
                            <div class="admin-stat-item">
                                <span class="admin-stat-value" id="playerBestTime">--</span>
                                <div class="admin-stat-label">Best Time</div>
                            </div>
                            <div class="admin-stat-item">
                                <span class="admin-stat-value" id="playerAvgTime">--</span>
                                <div class="admin-stat-label">Avg Time</div>
                            </div>
                            <div class="admin-stat-item">
                                <span class="admin-stat-value" id="playerWinRate">--</span>
                                <div class="admin-stat-label">Win Rate</div>
                            </div>
                            <div class="admin-stat-item">
                                <span class="admin-stat-value" id="playerAvgMoves">--</span>
                                <div class="admin-stat-label">Avg Moves</div>
                            </div>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Moves</th>
                                        <th>Background</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="playerGamesTableBody">
                                    <!-- Player's game history will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analytics Tab -->
                <div id="detailedContent" class="tab-content" style="display: none;">
                    <h4 style="margin: 0 0 15px 0; color: var(--green-darker);">� Detailed Game Analytics</h4>
                    <div class="admin-stat-grid" style="margin-bottom: 20px;">
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="totalGameSessions">0</span>
                            <div class="admin-stat-label">Total Sessions</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="avgSessionLength">--</span>
                            <div class="admin-stat-label">Avg Session</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="mostActiveDay">--</span>
                            <div class="admin-stat-label">Most Active Day</div>
                        </div>
                        <div class="admin-stat-item">
                            <span class="admin-stat-value" id="fastestSolve">--</span>
                            <div class="admin-stat-label">Fastest Solve</div>
                        </div>
                    </div>
                    <div style="max-height: 250px; overflow-y: auto;">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>Background</th>
                                    <th>Games Played</th>
                                    <th>Completion Rate</th>
                                    <th>Avg Time</th>
                                    <th>Avg Moves</th>
                                </tr>
                            </thead>
                            <tbody id="backgroundStatsTableBody">
                                <!-- Background statistics will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title-section">
                        <div class="card-icon">👥</div>
                        <h2 class="card-title">User Management</h2>
                    </div>
                </div>
                <div class="card-content">
                    <div style="max-height: 300px; overflow-y: auto;">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="admin-actions">
                    <button class="btn-admin btn-primary-admin" onclick="addNewUser()">
                        ➕ Add User
                    </button>
                </div>
                </div>
            </div>

            <!-- Background Image Management -->
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title-section">
                        <div class="card-icon">🖼️</div>
                        <h2 class="card-title">Background Image Management</h2>
                    </div>
                </div>
                
                <div class="card-content">
                    <!-- Upload Section -->
                    <div class="upload-section" style="margin-bottom: 15px; padding: 12px; background: var(--gray-50); border-radius: 6px; border-left: 3px solid var(--green-primary);">
                        <div class="upload-header" style="margin-bottom: 10px;">
                            <h4 style="margin: 0; color: var(--green-darker); font-size: 1rem; font-weight: 600;">
                                🖼️ Upload New Background Image
                            </h4>
                        </div>
                        
                        <form id="backgroundUploadForm" enctype="multipart/form-data">
                            <!-- Image Name Section -->
                            <div class="form-row" style="margin-bottom: 12px;">
                                <div class="form-group" style="margin: 0;">
                                    <label for="imageName" style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--gray-700); font-size: 0.9rem;">
                                        Image Name <span style="color: var(--red-500);">*</span>
                                    </label>
                                    <input type="text" id="imageName" class="form-input" required 
                                           placeholder="Enter a descriptive name for the image"
                                           style="width: 100%; max-width: 350px; padding: 6px 8px; font-size: 0.9rem;">
                                </div>
                            </div>
                            
                            <!-- Upload Method Section -->
                            <div class="form-row" style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-700); font-size: 0.9rem;">
                                    Upload Method
                                </label>
                                <div class="upload-method-container" style="display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Radio Button Options -->
                                    <div class="method-options" style="display: flex; gap: 15px; margin-bottom: 8px;">
                                        <label class="radio-option" style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: white; border-radius: 4px; border: 2px solid var(--gray-200); transition: all 0.2s; font-size: 0.9rem;">
                                            <input type="radio" name="uploadMethod" value="file" checked onchange="toggleUploadMethod()" style="margin: 0;">
                                            <span style="font-weight: 500;">📁 File Upload</span>
                                        </label>
                                        <label class="radio-option" style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: white; border-radius: 4px; border: 2px solid var(--gray-200); transition: all 0.2s; font-size: 0.9rem;">
                                            <input type="radio" name="uploadMethod" value="url" onchange="toggleUploadMethod()" style="margin: 0;">
                                            <span style="font-weight: 500;">🌐 CODD Server URL</span>
                                        </label>
                                    </div>
                                    
                                    <!-- File Input -->
                                    <div class="file-input-container" style="display: flex; flex-direction: column; gap: 5px;">
                                        <input type="file" id="imageFile" class="form-input" accept="image/*" 
                                               placeholder="Select image file"
                                               style="max-width: 350px; padding: 8px; border: 2px dashed var(--green-light); background: white; font-size: 0.9rem;">
                                        <small style="color: var(--gray-600); font-size: 0.8rem;">
                                            Supported formats: JPG, PNG, GIF, WebP (Max size: 5MB)
                                        </small>
                                    </div>
                                    
                                    <!-- URL Input -->
                                    <div class="url-input-container" style="display: none; flex-direction: column; gap: 5px;">
                                        <input type="url" id="imageUrl" class="form-input" 
                                               placeholder="https://codd.cs.gsu.edu/~username/image.jpg"
                                               style="max-width: 450px; padding: 6px 8px; font-size: 0.9rem;">
                                        <small style="color: var(--gray-600); font-size: 0.8rem;">
                                            Enter the direct URL to an image hosted on CODD server
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Options and Submit Section -->
                            <div class="form-actions" style="display: flex; align-items: center; justify-content: space-between; padding-top: 10px; border-top: 1px solid var(--gray-200);">
                                <label class="checkbox-option" style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px; background: white; border-radius: 4px; border: 1px solid var(--gray-200); font-size: 0.9rem;">
                                    <input type="checkbox" id="imageActive" checked style="margin: 0;">
                                    <span style="font-weight: 500; color: var(--gray-700);">✅ Set as active background</span>
                                </label>
                                <button type="submit" class="btn-admin btn-primary-admin" style="padding: 8px 16px; font-weight: 600; font-size: 0.9rem;">
                                    � Upload Image
                                </button>
                            </div>
                        </form>
                    </div>

                <!-- Background Images List -->
                <div>
                    <table class="user-table background-images-table">
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>Name</th>
                                <th>File Name</th>
                                <th>Status</th>
                                <th>Upload Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backgroundImagesTableBody">
                            <!-- Background images will be loaded here -->
                        </tbody>
                    </table>
                </div>
                </div>
            </div>

            <!-- System Configuration -->
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title-section">
                        <div class="card-icon">⚙️</div>
                        <h2 class="card-title">System Configuration</h2>
                    </div>
                </div>
                
                <div class="card-content">
                    <!-- Configuration Form -->
                    <form id="systemConfigForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <!-- Game Parameters Section -->
                        <div style="background: var(--gray-50); padding: 20px; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; color: var(--green-darker);">🎮 Game Parameters</h4>
                            
                            <div class="form-group">
                                <label for="defaultPuzzleSize">Default Puzzle Size:</label>
                                <select id="defaultPuzzleSize" class="form-input">
                                    <option value="3">3x3 (8 pieces)</option>
                                    <option value="4" selected>4x4 (15 pieces)</option>
                                    <option value="5">5x5 (24 pieces)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="availableSizes">Available Puzzle Sizes:</label>
                                <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 5px;">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="size3x3" checked>
                                        3x3 (Beginner)
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="size4x4" checked>
                                        4x4 (Standard)
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="size5x5" checked>
                                        5x5 (Expert)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="maxMovesForWin">Maximum Moves for Optimal Win:</label>
                                <input type="number" id="maxMovesForWin" class="form-input" min="20" max="200" value="100">
                                <small style="color: var(--gray-600);">Games completed within this move limit are considered "optimal"</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="timeLimit">Time Limit (minutes, 0 = no limit):</label>
                                <input type="number" id="timeLimit" class="form-input" min="0" max="60" value="0">
                                <small style="color: var(--gray-600);">Set a time limit for competitive play</small>
                            </div>
                        </div>
                        
                        <!-- Interface Settings Section -->
                        <div style="background: var(--gray-50); padding: 20px; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; color: var(--green-darker);">🎨 Interface Settings</h4>
                            
                            <div class="form-group">
                                <label for="enableSounds">Enable Sound Effects:</label>
                                <select id="enableSounds" class="form-input">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                    <option value="user">User Choice</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="enableBackgroundMusic">Enable Background Music:</label>
                                <select id="enableBackgroundMusic" class="form-input">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                    <option value="user" selected>User Choice</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="showMoveCounter">Show Move Counter:</label>
                                <select id="showMoveCounter" class="form-input">
                                    <option value="true" selected>Always Show</option>
                                    <option value="false">Hide</option>
                                    <option value="endgame">Show Only at End</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="showTimer">Show Timer:</label>
                                <select id="showTimer" class="form-input">
                                    <option value="true" selected>Always Show</option>
                                    <option value="false">Hide</option>
                                    <option value="endgame">Show Only at End</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="animationSpeed">Animation Speed:</label>
                                <select id="animationSpeed" class="form-input">
                                    <option value="slow">Slow (400ms)</option>
                                    <option value="normal" selected>Normal (250ms)</option>
                                    <option value="fast">Fast (150ms)</option>
                                    <option value="instant">Instant (0ms)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Difficulty & Scoring Section -->
                    <div style="background: var(--gray-50); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--green-darker);">🏆 Difficulty & Scoring</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="shuffleComplexity">Shuffle Complexity:</label>
                                <select id="shuffleComplexity" class="form-input">
                                    <option value="easy">Easy (50 moves)</option>
                                    <option value="medium" selected>Medium (100 moves)</option>
                                    <option value="hard">Hard (200 moves)</option>
                                    <option value="expert">Expert (500 moves)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="hintSystem">Hint System:</label>
                                <select id="hintSystem" class="form-input">
                                    <option value="disabled">Disabled</option>
                                    <option value="limited">Limited (3 hints)</option>
                                    <option value="unlimited" selected>Unlimited</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="scoringSystem">Scoring System:</label>
                                <select id="scoringSystem" class="form-input">
                                    <option value="time">Time-based</option>
                                    <option value="moves">Move-based</option>
                                    <option value="combined" selected>Combined</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button type="button" class="btn-admin btn-secondary-admin" onclick="resetToDefaults()">
                            🔄 Reset to Defaults
                        </button>
                        <button type="submit" class="btn-admin btn-primary-admin">
                            💾 Save Configuration
                        </button>
                    </div>
                </form>
                
                <!-- Configuration Status -->
                <div id="configStatus" style="margin-top: 20px; padding: 15px; background: var(--gray-100); border-radius: 8px; display: none;">
                    <h5 style="margin: 0 0 10px 0; color: var(--green-darker);">Configuration Status:</h5>
                    <div id="configStatusContent"></div>
                </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="fifteen.html" class="btn-admin btn-primary-admin" style="display: inline-flex; padding: 15px 30px;">
                ← Back to Game
            </a>
        </div>

        <!-- Edit User Modal -->
        <div id="editUserModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit User Details</h3>
                    <button class="modal-close" onclick="closeEditModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        
                        <div class="form-group">
                            <label for="editUsername">Username:</label>
                            <input type="text" id="editUsername" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editEmail">Email:</label>
                            <input type="email" id="editEmail" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label for="editPassword">New Password (leave blank to keep current):</label>
                            <input type="password" id="editPassword" class="form-input" placeholder="Enter new password or leave blank">
                        </div>
                        
                        <div class="form-group">
                            <label for="editStatus">Account Status:</label>
                            <select id="editStatus" class="form-input">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn-admin btn-secondary-admin" onclick="closeEditModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn-admin btn-primary-admin">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Background Image Modal -->
        <div id="editImageModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Background Image</h3>
                    <button class="modal-close" onclick="closeImageEditModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editImageForm">
                        <input type="hidden" id="editImageId">
                        
                        <div class="form-group">
                            <label>Current Image:</label>
                            <div style="text-align: center; margin: 10px 0;">
                                <img id="editImagePreview" src="" alt="Image Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid var(--gray-300);">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editImageName">Image Name:</label>
                            <input type="text" id="editImageName" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editImageActiveStatus">Status:</label>
                            <select id="editImageActiveStatus" class="form-input">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="replaceImageFile">Replace Image File (optional):</label>
                            <input type="file" id="replaceImageFile" class="form-input" accept="image/*">
                            <small style="color: var(--gray-600); font-size: 0.85rem;">Leave empty to keep current image file</small>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn-admin btn-secondary-admin" onclick="closeImageEditModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn-admin btn-primary-admin">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Debug: Check localStorage data
            console.log('=== DEBUGGING USER DATA ===');
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            console.log('Raw users from localStorage:', users);
            console.log('Number of users:', users.length);
            users.forEach((user, index) => {
                console.log(`User ${index}:`, {
                    id: user.id,
                    username: user.username,
                    hasId: !!user.id,
                    idType: typeof user.id
                });
            });
            console.log('=== END DEBUG ===');
            
            loadAdminData();
            loadUsers();
            loadBackgroundImages(); // Load background images
            refreshGameStatistics(); // Initialize game statistics
            loadSystemConfiguration(); // Initialize system configuration
            setupEventListeners();
            
            // Add form submission handler for edit user modal
            document.getElementById('editUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('=== FORM SUBMISSION DEBUG ===');
                const userId = document.getElementById('editUserId').value;
                const username = document.getElementById('editUsername').value;
                const email = document.getElementById('editEmail').value;
                const password = document.getElementById('editPassword').value;
                const isActive = document.getElementById('editStatus').value === 'true';
                
                console.log('Form data:', { userId, username, email, hasPassword: !!password, isActive });
                
                const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
                console.log('All users for form submission:', users);
                
                // Use the same robust ID matching logic
                let userIndex = users.findIndex(u => u.id === userId);
                if (userIndex === -1) {
                    userIndex = users.findIndex(u => u.id.toString() === userId.toString());
                }
                
                console.log('Found user index:', userIndex);
                
                if (userIndex === -1) {
                    console.error('User not found with ID:', userId);
                    console.log('Available user IDs:', users.map(u => ({ id: u.id, type: typeof u.id, username: u.username })));
                    alert('User not found! Please refresh the page and try again.');
                    return;
                }
                
                // Check if username is already taken by another user
                const existingUser = users.find(u => u.username === username && u.id !== userId && u.id.toString() !== userId.toString());
                if (existingUser) {
                    alert('Username is already taken by another user!');
                    return;
                }
                
                // Update user details
                users[userIndex].username = username;
                users[userIndex].email = email;
                users[userIndex].isActive = isActive;
                
                // Update password if provided
                if (password && password.trim() !== '') {
                    users[userIndex].password = password;
                    console.log('Password updated for user:', username);
                }
                
                localStorage.setItem('fifteenPuzzleUsers', JSON.stringify(users));
                console.log('User updated successfully:', users[userIndex]);
                
                alert(`User "${username}" has been updated successfully!`);
                closeEditModal();
                loadUsers(); // Refresh the table
                loadAdminData(); // Refresh stats
            });

            // Add form submission handler for background image upload
            document.getElementById('backgroundUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('=== BACKGROUND UPLOAD DEBUG ===');
                const imageName = document.getElementById('imageName').value;
                const imageFile = document.getElementById('imageFile').files[0];
                const imageUrl = document.getElementById('imageUrl').value;
                const isActive = document.getElementById('imageActive').checked;
                const uploadMethod = document.querySelector('input[name="uploadMethod"]:checked').value;
                
                if (uploadMethod === 'file' && !imageFile) {
                    alert('Please select an image file!');
                    return;
                }
                
                if (uploadMethod === 'url' && !imageUrl) {
                    alert('Please enter a valid image URL!');
                    return;
                }
                
                if (uploadMethod === 'file') {
                    // Handle file upload
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = e.target.result;
                        const fileName = imageFile.name;
                        const imageId = 'bg_' + Date.now();
                        
                        const newImage = {
                            id: imageId,
                            name: imageName,
                            fileName: fileName,
                            url: imageData,
                            isActive: isActive,
                            uploadDate: new Date().toISOString(),
                            fileSize: imageFile.size,
                            fileType: imageFile.type,
                            uploadMethod: 'file'
                        };
                        
                        saveAndRefreshBackgroundImages(newImage, imageName);
                    };
                    
                    reader.readAsDataURL(imageFile);
                } else if (uploadMethod === 'url') {
                    // Handle URL upload
                    const imageId = 'bg_' + Date.now();
                    const fileName = imageUrl.split('/').pop() || 'external_image';
                    
                    // Test if URL is accessible by creating an image element
                    const testImg = new Image();
                    testImg.onload = function() {
                        const newImage = {
                            id: imageId,
                            name: imageName,
                            fileName: fileName,
                            url: imageUrl,
                            isActive: isActive,
                            uploadDate: new Date().toISOString(),
                            fileSize: 'External URL',
                            fileType: 'External Image',
                            uploadMethod: 'url'
                        };
                        
                        saveAndRefreshBackgroundImages(newImage, imageName);
                    };
                    
                    testImg.onerror = function() {
                        alert('Error: Unable to load image from the provided URL. Please check the URL and try again.');
                    };
                    
                    testImg.src = imageUrl;
                }
                
                function saveAndRefreshBackgroundImages(newImage, imageName) {
                    // Save to localStorage (simulating database storage)
                    const images = JSON.parse(localStorage.getItem('fifteenPuzzleBackgroundImages') || '[]');
                    
                    // Simply add the new image without affecting existing images' status
                    images.push(newImage);
                    localStorage.setItem('fifteenPuzzleBackgroundImages', JSON.stringify(images));
                    
                    console.log('New image uploaded:', newImage);
                    alert(`Background image "${imageName}" has been uploaded successfully!`);
                    
                    // Reset form and refresh table
                    document.getElementById('backgroundUploadForm').reset();
                    toggleUploadMethod(); // Reset the upload method display
                    loadBackgroundImages();
                    notifyBackgroundChange(); // Notify game of changes
                }
            });

            // Add form submission handler for background image edit
            document.getElementById('editImageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('=== IMAGE EDIT FORM SUBMISSION DEBUG ===');
                const imageId = document.getElementById('editImageId').value;
                const imageName = document.getElementById('editImageName').value;
                const isActive = document.getElementById('editImageActiveStatus').value === 'true';
                const replaceFile = document.getElementById('replaceImageFile').files[0];
                
                console.log('Form data:', { imageId, imageName, isActive, hasReplaceFile: !!replaceFile });
                
                const images = JSON.parse(localStorage.getItem('fifteenPuzzleBackgroundImages') || '[]');
                const imageIndex = images.findIndex(img => img.id === imageId);
                
                if (imageIndex === -1) {
                    console.error('Image not found with ID:', imageId);
                    alert('Image not found! Please refresh the page and try again.');
                    return;
                }
                
                // Check if name is already taken by another image
                const existingImage = images.find(img => img.name === imageName && img.id !== imageId);
                if (existingImage) {
                    alert('Image name is already taken by another image!');
                    return;
                }
                
                // Update image details
                images[imageIndex].name = imageName;
                
                // If this image is set as active, deactivate others
                if (isActive) {
                    images.forEach(img => img.isActive = false);
                }
                images[imageIndex].isActive = isActive;
                
                // Handle file replacement
                if (replaceFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        images[imageIndex].url = e.target.result;
                        images[imageIndex].fileName = replaceFile.name;
                        images[imageIndex].fileSize = replaceFile.size;
                        images[imageIndex].fileType = replaceFile.type;
                        images[imageIndex].uploadDate = new Date().toISOString();
                        
                        localStorage.setItem('fifteenPuzzleBackgroundImages', JSON.stringify(images));
                        
                        console.log('Image updated with new file:', images[imageIndex]);
                        alert(`Background image "${imageName}" has been updated successfully!`);
                        closeImageEditModal();
                        loadBackgroundImages();
                        notifyBackgroundChange(); // Notify game of changes
                    };
                    reader.readAsDataURL(replaceFile);
                } else {
                    // Update without file replacement
                    localStorage.setItem('fifteenPuzzleBackgroundImages', JSON.stringify(images));
                    
                    console.log('Image updated without file change:', images[imageIndex]);
                    alert(`Background image "${imageName}" has been updated successfully!`);
                    closeImageEditModal();
                    loadBackgroundImages();
                    notifyBackgroundChange(); // Notify game of changes
                }
            });
        });

        // Add form submission handler for system configuration
        document.getElementById('systemConfigForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (saveSystemConfiguration()) {
                // Configuration saved successfully
                console.log('System configuration saved successfully');
            }
        });

        function loadAdminData() {
            const currentUser = JSON.parse(localStorage.getItem('fifteenPuzzleCurrentUser') || '{}');
            if (currentUser.username) {
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userRole').textContent = currentUser.role || 'Administrator';
                document.getElementById('userInitials').textContent = currentUser.username.charAt(0).toUpperCase();
                
                // Apply role-based menu visibility
                const userRole = currentUser.role || 'Administrator';
                if (userRole.toLowerCase() !== 'administrator' && userRole.toLowerCase() !== 'admin') {
                    document.body.classList.add('user-role-player');
                }
            }

            // Load system stats
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            
            // Ensure users have IDs - use simpler ID generation
            let updated = false;
            users.forEach((user, index) => {
                if (!user.id) {
                    user.id = Date.now().toString() + index.toString();
                    updated = true;
                    console.log(`Assigned ID ${user.id} to user ${user.username} in loadAdminData`);
                }
            });
            
            // Save back if we added IDs
            if (updated) {
                localStorage.setItem('fifteenPuzzleUsers', JSON.stringify(users));
                console.log('Updated users with IDs in loadAdminData:', users);
            }
            
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = users.filter(u => u.isActive !== false).length;
            
            // Load real game statistics instead of mock data
            const gameStats = JSON.parse(localStorage.getItem('fifteenPuzzleGameStats') || '[]');
            document.getElementById('totalGamesPlayed').textContent = gameStats.length;
        }

        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            const tbody = document.getElementById('userTableBody');
            
            // Ensure users have IDs - use simpler, safer ID generation
            let updated = false;
            users.forEach((user, index) => {
                if (!user.id) {
                    // Create a simple numeric ID
                    user.id = Date.now().toString() + index.toString();
                    updated = true;
                    console.log(`Assigned ID ${user.id} to user ${user.username}`);
                }
            });
            
            // Save users back with IDs
            if (updated) {
                localStorage.setItem('fifteenPuzzleUsers', JSON.stringify(users));
                console.log('Updated users with IDs:', users);
            }
            
            // Debug: Log each user's ID before creating buttons
            console.log('Creating buttons for users:');
            users.forEach(user => {
                console.log(`User: ${user.username}, ID: ${user.id}, Type: ${typeof user.id}`);
            });
            
            tbody.innerHTML = users.map((user, index) => {
                const userId = user.id.toString(); // Ensure it's a string
                console.log(`Creating buttons for user ${user.username} with ID: ${userId}`);
                return `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.role || 'user'}</td>
                    <td><span class="user-status ${user.isActive !== false ? 'status-active' : 'status-inactive'}">${user.isActive !== false ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="action-btn-compact btn-edit-compact" onclick="editUser('${userId}')" title="Edit User">
                            ✏️ Edit
                        </button>
                        <button class="action-btn-compact btn-toggle-compact" onclick="toggleUserStatus('${userId}')" title="${user.isActive !== false ? 'Deactivate' : 'Activate'} User">
                            ${user.isActive !== false ? '🔒 Deactivate' : '🔓 Activate'}
                        </button>
                        <button class="action-btn-compact btn-delete-compact" onclick="deleteUser('${userId}')" title="Delete User">
                            🗑️ Delete
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        function setupEventListeners() {
            // User dropdown functionality
            const userMenuToggle = document.getElementById('userMenuToggle');
            const userDropdown = document.getElementById('userDropdown');

            userMenuToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdown.classList.toggle('show');
            });

            document.addEventListener('click', function() {
                userDropdown.classList.remove('show');
            });

            // Logout functionality
            document.getElementById('logoutButton').addEventListener('click', function() {
                localStorage.removeItem('fifteenPuzzleCurrentUser');
                window.location.href = 'fifteen.html';
            });

            // Admin Dashboard navigation
            const adminDashboardItem = document.getElementById('adminDashboardItem');
            if (adminDashboardItem) {
                adminDashboardItem.addEventListener('click', function() {
                    // Already on admin dashboard, just close the dropdown
                    userDropdown.classList.remove('show');
                });
            }
        }

        // Admin action functions
        function refreshSystemStats() { alert('System stats refreshed!'); }
        function showUserSettings() { alert('User settings panel would open here.'); }
        function addNewUser() { alert('Add new user form would open here.'); }
        // ========================
        // GAME STATISTICS FUNCTIONALITY
        // ========================

        function refreshGameStatistics() {
            loadAggregateStatistics();
            loadLeaderboard();
            loadPlayerSelector();
            loadDetailedAnalytics();
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').style.display = 'block';
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load specific data based on tab
            if (tabName === 'leaderboard') {
                loadLeaderboard();
            } else if (tabName === 'individual') {
                loadPlayerSelector();
            } else if (tabName === 'detailed') {
                loadDetailedAnalytics();
            }
        }

        function loadAggregateStatistics() {
            const gameStats = getGameStatistics();
            const userStats = getUserStatistics();
            
            document.getElementById('totalGamesPlayed').textContent = gameStats.totalGames;
            document.getElementById('totalPlayersActive').textContent = userStats.activeUsers;
            document.getElementById('avgCompletionTime').textContent = gameStats.avgTime;
            document.getElementById('avgMoves').textContent = gameStats.avgMoves;
            document.getElementById('completionRate').textContent = gameStats.completionRate;
            document.getElementById('mostPopularPuzzle').textContent = gameStats.popularBackground;
        }

        function loadLeaderboard() {
            const leaderboardData = generateLeaderboardData();
            const tbody = document.getElementById('leaderboardTableBody');
            
            tbody.innerHTML = '';
            
            leaderboardData.forEach((player, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>#${index + 1}</strong></td>
                    <td>${player.username}</td>
                    <td>${player.bestTime}</td>
                    <td>${player.gamesWon}</td>
                    <td>${player.winRate}</td>
                    <td>${player.avgMoves}</td>
                `;
            });
        }

        function loadPlayerSelector() {
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            const selector = document.getElementById('playerSelector');
            
            selector.innerHTML = '<option value="">Select a player...</option>';
            
            users.forEach(user => {
                if (user.role === 'player') {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    selector.appendChild(option);
                }
            });
        }

        function loadPlayerStats() {
            const selectedPlayer = document.getElementById('playerSelector').value;
            const statsContent = document.getElementById('playerStatsContent');
            
            if (!selectedPlayer) {
                statsContent.style.display = 'none';
                return;
            }
            
            const playerData = getPlayerStatistics(selectedPlayer);
            
            document.getElementById('playerTotalGames').textContent = playerData.totalGames;
            document.getElementById('playerGamesWon').textContent = playerData.gamesWon;
            document.getElementById('playerBestTime').textContent = playerData.bestTime;
            document.getElementById('playerAvgTime').textContent = playerData.avgTime;
            document.getElementById('playerWinRate').textContent = playerData.winRate;
            document.getElementById('playerAvgMoves').textContent = playerData.avgMoves;
            
            // Load player's game history
            const tbody = document.getElementById('playerGamesTableBody');
            tbody.innerHTML = '';
            
            playerData.gameHistory.forEach(game => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${game.date}</td>
                    <td>${game.time}</td>
                    <td>${game.moves}</td>
                    <td>${game.background}</td>
                    <td><span class="user-status status-${game.completed ? 'active' : 'inactive'}">${game.completed ? 'Won' : 'Quit'}</span></td>
                `;
            });
            
            statsContent.style.display = 'block';
        }

        function loadDetailedAnalytics() {
            const detailedStats = getDetailedStatistics();
            
            document.getElementById('totalGameSessions').textContent = detailedStats.totalSessions;
            document.getElementById('avgSessionLength').textContent = detailedStats.avgSessionLength;
            document.getElementById('mostActiveDay').textContent = detailedStats.mostActiveDay;
            document.getElementById('fastestSolve').textContent = detailedStats.fastestSolve;
            
            // Load background statistics
            const tbody = document.getElementById('backgroundStatsTableBody');
            tbody.innerHTML = '';
            
            detailedStats.backgroundStats.forEach(bg => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${bg.name}</td>
                    <td>${bg.gamesPlayed}</td>
                    <td>${bg.completionRate}</td>
                    <td>${bg.avgTime}</td>
                    <td>${bg.avgMoves}</td>
                `;
            });
        }

        // ========================
        // STATISTICS DATA GENERATORS
        // ========================

        function getGameStatistics() {
            // Get real game statistics from localStorage
            const gameData = JSON.parse(localStorage.getItem('fifteenPuzzleGameStats') || '[]');
            
            if (gameData.length === 0) {
                // Return empty/default statistics when no games have been played
                return {
                    totalGames: 0,
                    avgTime: '--',
                    avgMoves: '--',
                    completionRate: '--',
                    popularBackground: 'None'
                };
            }
            
            const totalGames = gameData.length;
            const completedGames = gameData.filter(game => game.completed);
            const completionRate = totalGames > 0 ? Math.round((completedGames.length / totalGames) * 100) : 0;
            
            const avgTime = completedGames.length > 0 
                ? formatTime(completedGames.reduce((sum, game) => sum + game.timeInSeconds, 0) / completedGames.length)
                : '--';
                
            const avgMoves = completedGames.length > 0 
                ? Math.round(completedGames.reduce((sum, game) => sum + game.moves, 0) / completedGames.length)
                : '--';
            
            // Find most popular background
            let popularBackground = 'Default';
            if (gameData.length > 0) {
                const backgroundCounts = {};
                gameData.forEach(game => {
                    const bg = game.background || 'Default';
                    backgroundCounts[bg] = (backgroundCounts[bg] || 0) + 1;
                });
                popularBackground = Object.keys(backgroundCounts).reduce((a, b) => 
                    backgroundCounts[a] > backgroundCounts[b] ? a : b, 'Default'
                );
            }
            
            return {
                totalGames,
                avgTime,
                avgMoves: avgMoves.toString(),
                completionRate: `${completionRate}%`,
                popularBackground
            };
        }

        function getUserStatistics() {
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            const activeUsers = users.filter(user => user.role === 'player').length;
            
            return { activeUsers };
        }

        function generateLeaderboardData() {
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            const gameData = JSON.parse(localStorage.getItem('fifteenPuzzleGameStats') || '[]');
            
            const playerStats = {};
            
            // Initialize player stats
            users.filter(user => user.role === 'player').forEach(user => {
                playerStats[user.username] = {
                    username: user.username,
                    totalGames: 0,
                    gamesWon: 0,
                    bestTime: null,
                    totalTime: 0,
                    totalMoves: 0
                };
            });
            
            // Calculate stats from game data
            gameData.forEach(game => {
                if (playerStats[game.player]) {
                    const stats = playerStats[game.player];
                    stats.totalGames++;
                    
                    if (game.completed) {
                        stats.gamesWon++;
                        stats.totalTime += game.timeInSeconds;
                        stats.totalMoves += game.moves;
                        
                        if (!stats.bestTime || game.timeInSeconds < stats.bestTime) {
                            stats.bestTime = game.timeInSeconds;
                        }
                    }
                }
            });
            
            // Convert to leaderboard format and sort by win rate and best time
            return Object.values(playerStats)
                .map(stats => ({
                    username: stats.username,
                    gamesWon: stats.gamesWon,
                    winRate: stats.totalGames > 0 ? `${Math.round((stats.gamesWon / stats.totalGames) * 100)}%` : '0%',
                    bestTime: stats.bestTime ? formatTime(stats.bestTime) : '--',
                    avgMoves: stats.gamesWon > 0 ? Math.round(stats.totalMoves / stats.gamesWon) : '--'
                }))
                .sort((a, b) => {
                    const aWinRate = parseInt(a.winRate);
                    const bWinRate = parseInt(b.winRate);
                    if (aWinRate !== bWinRate) return bWinRate - aWinRate;
                    
                    const aTime = a.bestTime === '--' ? Infinity : timeToSeconds(a.bestTime);
                    const bTime = b.bestTime === '--' ? Infinity : timeToSeconds(b.bestTime);
                    return aTime - bTime;
                })
                .slice(0, 10); // Top 10 players
        }

        function getPlayerStatistics(playerName) {
            const gameData = JSON.parse(localStorage.getItem('fifteenPuzzleGameStats') || '[]');
            const playerGames = gameData.filter(game => game.player === playerName);
            
            const totalGames = playerGames.length;
            const completedGames = playerGames.filter(game => game.completed);
            const gamesWon = completedGames.length;
            
            const winRate = totalGames > 0 ? `${Math.round((gamesWon / totalGames) * 100)}%` : '0%';
            const bestTime = completedGames.length > 0 
                ? formatTime(Math.min(...completedGames.map(game => game.timeInSeconds)))
                : '--';
            const avgTime = completedGames.length > 0 
                ? formatTime(completedGames.reduce((sum, game) => sum + game.timeInSeconds, 0) / completedGames.length)
                : '--';
            const avgMoves = completedGames.length > 0 
                ? Math.round(completedGames.reduce((sum, game) => sum + game.moves, 0) / completedGames.length)
                : '--';
            
            const gameHistory = playerGames.slice(-10).reverse().map(game => ({
                date: new Date(game.date).toLocaleDateString(),
                time: game.completed ? formatTime(game.timeInSeconds) : '--',
                moves: game.moves,
                background: game.background || 'Default',
                completed: game.completed
            }));
            
            return {
                totalGames,
                gamesWon,
                winRate,
                bestTime,
                avgTime,
                avgMoves: avgMoves.toString(),
                gameHistory
            };
        }

        function getDetailedStatistics() {
            const gameData = JSON.parse(localStorage.getItem('fifteenPuzzleGameStats') || '[]');
            
            if (gameData.length === 0) {
                return {
                    totalSessions: 0,
                    avgSessionLength: '--',
                    mostActiveDay: '--',
                    fastestSolve: '--',
                    backgroundStats: []
                };
            }
            
            const totalSessions = gameData.length;
            const completedGames = gameData.filter(game => game.completed);
            
            const avgSessionLength = completedGames.length > 0 
                ? formatTime(completedGames.reduce((sum, game) => sum + game.timeInSeconds, 0) / completedGames.length)
                : '--';
            
            // Find most active day
            const dayCounts = {};
            gameData.forEach(game => {
                const day = new Date(game.date).toLocaleDateString('en-US', { weekday: 'long' });
                dayCounts[day] = (dayCounts[day] || 0) + 1;
            });
            const mostActiveDay = Object.keys(dayCounts).length > 0 
                ? Object.keys(dayCounts).reduce((a, b) => dayCounts[a] > dayCounts[b] ? a : b)
                : '--';
            
            const fastestSolve = completedGames.length > 0 
                ? formatTime(Math.min(...completedGames.map(game => game.timeInSeconds)))
                : '--';
            
            // Background statistics
            const backgroundStats = {};
            gameData.forEach(game => {
                const bg = game.background || 'Default';
                if (!backgroundStats[bg]) {
                    backgroundStats[bg] = {
                        name: bg,
                        games: [],
                        completed: 0
                    };
                }
                backgroundStats[bg].games.push(game);
                if (game.completed) backgroundStats[bg].completed++;
            });
            
            const backgroundStatsArray = Object.values(backgroundStats).map(bg => ({
                name: bg.name,
                gamesPlayed: bg.games.length,
                completionRate: bg.games.length > 0 ? `${Math.round((bg.completed / bg.games.length) * 100)}%` : '0%',
                avgTime: bg.completed > 0 
                    ? formatTime(bg.games.filter(g => g.completed).reduce((sum, g) => sum + g.timeInSeconds, 0) / bg.completed)
                    : '--',
                avgMoves: bg.completed > 0 
                    ? Math.round(bg.games.filter(g => g.completed).reduce((sum, g) => sum + g.moves, 0) / bg.completed)
                    : '--'
            }));
            
            return {
                totalSessions,
                avgSessionLength,
                mostActiveDay,
                fastestSolve,
                backgroundStats: backgroundStatsArray
            };
        }

        function generateSampleGameData() {
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            const players = users.filter(user => user.role === 'player');
            
            if (players.length === 0) return;
            
            const backgrounds = ['Nature Scene', 'City View', 'Abstract Art', 'Ocean Blue'];
            const sampleData = [];
            
            // Generate 50 sample games
            for (let i = 0; i < 50; i++) {
                const player = players[Math.floor(Math.random() * players.length)];
                const completed = Math.random() > 0.3; // 70% completion rate
                const timeInSeconds = completed ? 60 + Math.random() * 300 : 0; // 1-6 minutes
                const moves = completed ? 25 + Math.random() * 50 : Math.random() * 20;
                
                sampleData.push({
                    id: 'game_' + Date.now() + '_' + i,
                    player: player.username,
                    date: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                    timeInSeconds: Math.round(timeInSeconds),
                    moves: Math.round(moves),
                    completed,
                    background: backgrounds[Math.floor(Math.random() * backgrounds.length)]
                });
            }
            
            localStorage.setItem('fifteenPuzzleGameStats', JSON.stringify(sampleData));
        }

        // ========================
        // UTILITY FUNCTIONS
        // ========================

        function formatTime(seconds) {
            if (!seconds || seconds === 0) return '--';
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function timeToSeconds(timeString) {
            if (timeString === '--') return 0;
            const [mins, secs] = timeString.split(':').map(Number);
            return mins * 60 + secs;
        }

        // ========================
        // SYSTEM CONFIGURATION FUNCTIONALITY
        // ========================

        // Default configuration values
        const DEFAULT_CONFIG = {
            defaultPuzzleSize: 4,
            availableSizes: {
                size3x3: true,
                size4x4: true,
                size5x5: true
            },
            maxMovesForWin: 100,
            timeLimit: 0,
            enableSounds: 'user',
            enableBackgroundMusic: 'user',
            showMoveCounter: 'true',
            showTimer: 'true',
            animationSpeed: 'normal',
            shuffleComplexity: 'medium',
            hintSystem: 'unlimited',
            scoringSystem: 'combined'
        };

        function loadSystemConfiguration() {
            const config = getSystemConfiguration();
            
            // Load game parameters
            document.getElementById('defaultPuzzleSize').value = config.defaultPuzzleSize;
            document.getElementById('size3x3').checked = config.availableSizes.size3x3;
            document.getElementById('size4x4').checked = config.availableSizes.size4x4;
            document.getElementById('size5x5').checked = config.availableSizes.size5x5;
            document.getElementById('maxMovesForWin').value = config.maxMovesForWin;
            document.getElementById('timeLimit').value = config.timeLimit;
            
            // Load interface settings
            document.getElementById('enableSounds').value = config.enableSounds;
            document.getElementById('enableBackgroundMusic').value = config.enableBackgroundMusic;
            document.getElementById('showMoveCounter').value = config.showMoveCounter;
            document.getElementById('showTimer').value = config.showTimer;
            document.getElementById('animationSpeed').value = config.animationSpeed;
            
            // Load difficulty & scoring
            document.getElementById('shuffleComplexity').value = config.shuffleComplexity;
            document.getElementById('hintSystem').value = config.hintSystem;
            document.getElementById('scoringSystem').value = config.scoringSystem;
            
            showConfigStatus('Configuration loaded successfully!', 'success');
        }

        function getSystemConfiguration() {
            const storedConfig = localStorage.getItem('fifteenPuzzleSystemConfig');
            if (storedConfig) {
                try {
                    return { ...DEFAULT_CONFIG, ...JSON.parse(storedConfig) };
                } catch (e) {
                    console.error('Error parsing system configuration:', e);
                    return DEFAULT_CONFIG;
                }
            }
            return DEFAULT_CONFIG;
        }

        function saveSystemConfiguration() {
            const config = {
                defaultPuzzleSize: parseInt(document.getElementById('defaultPuzzleSize').value),
                availableSizes: {
                    size3x3: document.getElementById('size3x3').checked,
                    size4x4: document.getElementById('size4x4').checked,
                    size5x5: document.getElementById('size5x5').checked
                },
                maxMovesForWin: parseInt(document.getElementById('maxMovesForWin').value),
                timeLimit: parseInt(document.getElementById('timeLimit').value),
                enableSounds: document.getElementById('enableSounds').value,
                enableBackgroundMusic: document.getElementById('enableBackgroundMusic').value,
                showMoveCounter: document.getElementById('showMoveCounter').value,
                showTimer: document.getElementById('showTimer').value,
                animationSpeed: document.getElementById('animationSpeed').value,
                shuffleComplexity: document.getElementById('shuffleComplexity').value,
                hintSystem: document.getElementById('hintSystem').value,
                scoringSystem: document.getElementById('scoringSystem').value,
                lastModified: new Date().toISOString(),
                modifiedBy: JSON.parse(localStorage.getItem('fifteenPuzzleCurrentUser') || '{}').username || 'admin'
            };
            
            // Validation
            const validation = validateConfiguration(config);
            if (!validation.valid) {
                showConfigStatus('Configuration Error: ' + validation.message, 'error');
                return false;
            }
            
            localStorage.setItem('fifteenPuzzleSystemConfig', JSON.stringify(config));
            showConfigStatus('Configuration saved successfully! Changes will take effect on next game start.', 'success');
            
            // Notify game about configuration changes
            notifyGameConfigurationChange();
            
            return true;
        }

        function validateConfiguration(config) {
            // Check if at least one puzzle size is enabled
            const availableSizes = Object.values(config.availableSizes);
            if (!availableSizes.some(size => size)) {
                return { valid: false, message: 'At least one puzzle size must be enabled' };
            }
            
            // Check if default size is among available sizes
            const sizeMapping = { 3: 'size3x3', 4: 'size4x4', 5: 'size5x5' };
            const defaultSizeKey = sizeMapping[config.defaultPuzzleSize];
            if (!config.availableSizes[defaultSizeKey]) {
                return { valid: false, message: 'Default puzzle size must be enabled in available sizes' };
            }
            
            // Validate move limit
            if (config.maxMovesForWin < 20 || config.maxMovesForWin > 1000) {
                return { valid: false, message: 'Maximum moves must be between 20 and 1000' };
            }
            
            // Validate time limit
            if (config.timeLimit < 0 || config.timeLimit > 120) {
                return { valid: false, message: 'Time limit must be between 0 and 120 minutes' };
            }
            
            return { valid: true };
        }

        function resetToDefaults() {
            if (confirm('Reset all configuration settings to default values? This action cannot be undone.')) {
                localStorage.removeItem('fifteenPuzzleSystemConfig');
                loadSystemConfiguration();
                showConfigStatus('Configuration reset to default values.', 'info');
            }
        }

        function getCurrentFormConfiguration() {
            return {
                defaultPuzzleSize: parseInt(document.getElementById('defaultPuzzleSize').value),
                availableSizes: {
                    size3x3: document.getElementById('size3x3').checked,
                    size4x4: document.getElementById('size4x4').checked,
                    size5x5: document.getElementById('size5x5').checked
                },
                maxMovesForWin: parseInt(document.getElementById('maxMovesForWin').value),
                timeLimit: parseInt(document.getElementById('timeLimit').value),
                enableSounds: document.getElementById('enableSounds').value,
                enableBackgroundMusic: document.getElementById('enableBackgroundMusic').value,
                showMoveCounter: document.getElementById('showMoveCounter').value,
                showTimer: document.getElementById('showTimer').value,
                animationSpeed: document.getElementById('animationSpeed').value,
                shuffleComplexity: document.getElementById('shuffleComplexity').value,
                hintSystem: document.getElementById('hintSystem').value,
                scoringSystem: document.getElementById('scoringSystem').value
            };
        }

        function showConfigStatus(message, type) {
            const statusDiv = document.getElementById('configStatus');
            const contentDiv = document.getElementById('configStatusContent');
            
            const colors = {
                success: '#22c55e',
                error: '#ef4444',
                info: '#3b82f6',
                warning: '#f59e0b'
            };
            
            statusDiv.style.display = 'block';
            statusDiv.style.borderLeft = `4px solid ${colors[type] || colors.info}`;
            contentDiv.innerHTML = message;
            
            // Auto-hide after 10 seconds for success/info messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 10000);
            }
        }

        function notifyGameConfigurationChange() {
            // Update timestamp to trigger configuration reload in game
            localStorage.setItem('fifteenPuzzleConfigLastUpdate', Date.now().toString());
            
            // Send postMessage to any open game windows
            try {
                if (typeof window.postMessage === 'function') {
                    window.postMessage({
                        type: 'configurationUpdated',
                        timestamp: Date.now()
                    }, '*');
                }
            } catch (e) {
                console.log('Could not send configuration update message:', e);
            }
        }

        function emergencyStop() { if(confirm('Emergency stop system?')) alert('System stopped!'); }
        
        // User Management Functions
        function editUser(userId) { 
            console.log('=== EDIT USER DEBUG ===');
            console.log('Received userId:', userId, 'Type:', typeof userId);
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            console.log('All users:', users);
            
            // Try both string and number comparison
            let user = users.find(u => u.id === userId);
            if (!user) {
                user = users.find(u => u.id.toString() === userId.toString());
            }
            
            console.log('Found user:', user);
            
            if (!user) {
                console.error('User not found with ID:', userId);
                console.log('Available user IDs:', users.map(u => ({ id: u.id, type: typeof u.id, username: u.username })));
                alert('User not found! Please refresh the page and try again.');
                return;
            }
            
            // Populate the edit form
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editPassword').value = ''; // Always start blank for security
            document.getElementById('editStatus').value = user.isActive !== false ? 'true' : 'false';
            
            // Show the modal
            document.getElementById('editUserModal').style.display = 'flex';
        }
        
        function toggleUserStatus(userId) {
            console.log('=== TOGGLE STATUS DEBUG ===');
            console.log('Received userId:', userId, 'Type:', typeof userId);
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            
            // Try both string and number comparison
            let userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) {
                userIndex = users.findIndex(u => u.id.toString() === userId.toString());
            }
            
            console.log('Found user index:', userIndex);
            
            if (userIndex === -1) {
                console.error('User not found with ID:', userId);
                console.log('Available user IDs:', users.map(u => ({ id: u.id, type: typeof u.id, username: u.username })));
                alert('User not found! Please refresh the page and try again.');
                return;
            }
            
            const user = users[userIndex];
            const newStatus = user.isActive !== false ? false : true;
            const action = newStatus ? 'activate' : 'deactivate';
            
            if (confirm(`Are you sure you want to ${action} user "${user.username}"?`)) {
                users[userIndex].isActive = newStatus;
                localStorage.setItem('fifteenPuzzleUsers', JSON.stringify(users));
                
                alert(`User "${user.username}" has been ${action}d successfully!`);
                loadUsers(); // Refresh the table
            }
        }
        
        function deleteUser(userId) { 
            console.log('=== DELETE USER DEBUG ===');
            console.log('Received userId:', userId, 'Type:', typeof userId);
            const users = JSON.parse(localStorage.getItem('fifteenPuzzleUsers') || '[]');
            
            // Try both string and number comparison
            let user = users.find(u => u.id === userId);
            if (!user) {
                user = users.find(u => u.id.toString() === userId.toString());
            }
            
            console.log('Found user:', user);
            
            if (!user) {
                console.error('User not found with ID:', userId);
                console.log('Available user IDs:', users.map(u => ({ id: u.id, type: typeof u.id, username: u.username })));
                alert('User not found! Please refresh the page and try again.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete user "${user.username}"? This action cannot be undone.`)) {
                const filteredUsers = users.filter(u => u.id !== userId && u.id.toString() !== userId.toString());
                localStorage.setItem('fifteenPuzzleUsers', JSON.stringify(filteredUsers));
                
                alert(`User "${user.username}" has been deleted successfully!`);
                loadUsers(); // Refresh the table
                loadAdminData(); // Refresh stats
            }
        }
        
        function closeEditModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        // Background Image Management Functions
        function loadBackgroundImages() {
            const images = JSON.parse(localStorage.getItem('fifteenPuzzleBackgroundImages') || '[]');
            const tbody = document.getElementById('backgroundImagesTableBody');
            
            // Initialize with default backgrounds if empty
            if (images.length === 0) {
                initializeDefaultBackgrounds();
                return;
            }
            
            tbody.innerHTML = images.map((image, index) => {
                const uploadDate = image.uploadDate ? new Date(image.uploadDate).toLocaleDateString() : 'Unknown';
                return `
                <tr>
                    <td>
                        <img src="${image.url}" alt="${image.name}" style="width: 50px; height: 35px; object-fit: cover; border-radius: 4px; border: 1px solid var(--gray-300);">
                    </td>
                    <td>${image.name}</td>
                    <td>${image.fileName}</td>
                    <td><span class="user-status ${image.isActive ? 'status-active' : 'status-inactive'}">${image.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>${uploadDate}</td>
                    <td>
                        <button class="action-btn-compact btn-edit-compact" onclick="editBackgroundImage('${image.id}')" title="Edit Image">
                            ✏️ Edit
                        </button>
                        <button class="action-btn-compact btn-toggle-compact" onclick="toggleImageStatus('${image.id}')" title="${image.isActive ? 'Deactivate' : 'Activate'} Image">
                            ${image.isActive ? '🔒 Deactivate' : '🔓 Activate'}
                        </button>
                        <button class="action-btn-compact btn-delete-compact" onclick="deleteBackgroundImage('${image.id}')" title="Delete Image">
                            🗑️ Delete
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        function initializeDefaultBackgrounds() {
            const defaultImages = [
                {
                    id: 'bg_default_1',
                    name: 'Nature Scene',
                    fileName: 'background1.png',
                    url: 'resources/background1.png',
                    isActive: true,
                    uploadDate: new Date().toISOString()
                },
                {
                    id: 'bg_default_2',
                    name: 'City View',
                    fileName: 'background2.png',
                    url: 'resources/background2.png',
                    isActive: true,
                    uploadDate: new Date().toISOString()
                },
                {
                    id: 'bg_default_3',
                    name: 'Abstract Art',
                    fileName: 'background3.png',
                    url: 'resources/background3.png',
                    isActive: true,
                    uploadDate: new Date().toISOString()
                },
                {
                    id: 'bg_default_4',
                    name: 'Ocean Blue',
                    fileName: 'background4.png',
                    url: 'resources/background4.png',
                    isActive: true,
                    uploadDate: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('fifteenPuzzleBackgroundImages', JSON.stringify(defaultImages));
            loadBackgroundImages();
        }

        function editBackgroundImage(imageId) {
            console.log('=== EDIT IMAGE DEBUG ===');
            console.log('Received imageId:', imageId);
            const images = JSON.parse(localStorage.getItem('fifteenPuzzleBackgroundImages') || '[]');
            const image = images.find(img => img.id === imageId);
            
            if (!image) {
                console.error('Image not found with ID:', imageId);
                alert('Image not found! Please refresh the page and try again.');
                return;
            }
            
            // Populate the edit form
            document.getElementById('editImageId').value = image.id;
            document.getElementById('editImageName').value = image.name;
            document.getElementById('editImageActiveStatus').value = image.isActive ? 'true' : 'false';
            document.getElementById('editImagePreview').src = image.url;
            document.getElementById('replaceImageFile').value = ''; // Clear file input
            
            // Show the modal
            document.getElementById('editImageModal').style.display = 'flex';
        }

        function toggleImageStatus(imageId) {
            console.log('=== TOGGLE IMAGE STATUS DEBUG ===');
            console.log('Received imageId:', imageId);
            const images = JSON.parse(localStorage.getItem('fifteenPuzzleBackgroundImages') || '[]');
            const imageIndex = images.findIndex(img => img.id === imageId);
            
            if (imageIndex === -1) {
                console.error('Image not found with ID:', imageId);
                alert('Image not found! Please refresh the page and try again.');
                return;
            }
            
            const image = images[imageIndex];
            const newStatus = !image.isActive;
            const action = newStatus ? 'activate' : 'deactivate';
            
            if (confirm(`Are you sure you want to ${action} image "${image.name}"?`)) {
                images[imageIndex].isActive = newStatus;
                localStorage.setItem('fifteenPuzzleBackgroundImages', JSON.stringify(images));
                
                alert(`Image "${image.name}" has been ${action}d successfully!`);
                loadBackgroundImages(); // Refresh the table
                notifyBackgroundChange(); // Notify game of changes
            }
        }

        function deleteBackgroundImage(imageId) {
            console.log('=== DELETE IMAGE DEBUG ===');
            console.log('Received imageId:', imageId);
            const images = JSON.parse(localStorage.getItem('fifteenPuzzleBackgroundImages') || '[]');
            const image = images.find(img => img.id === imageId);
            
            if (!image) {
                console.error('Image not found with ID:', imageId);
                alert('Image not found! Please refresh the page and try again.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete image "${image.name}"? This action cannot be undone.`)) {
                const filteredImages = images.filter(img => img.id !== imageId);
                localStorage.setItem('fifteenPuzzleBackgroundImages', JSON.stringify(filteredImages));
                
                alert(`Image "${image.name}" has been deleted successfully!`);
                loadBackgroundImages(); // Refresh the table
                notifyBackgroundChange(); // Notify game of changes
            }
        }

        function closeImageEditModal() {
            document.getElementById('editImageModal').style.display = 'none';
        }

        function showImageSettings() {
            alert('Image settings panel would open here (batch operations, compression settings, etc.)');
        }

        function refreshImageCache() {
            alert('Image cache refreshed! All background images have been reloaded.');
            loadBackgroundImages();
        }

        function toggleUploadMethod() {
            const fileRadio = document.querySelector('input[name="uploadMethod"][value="file"]');
            const urlRadio = document.querySelector('input[name="uploadMethod"][value="url"]');
            const fileContainer = document.querySelector('.file-input-container');
            const urlContainer = document.querySelector('.url-input-container');
            const fileInput = document.getElementById('imageFile');
            const urlInput = document.getElementById('imageUrl');
            
            // Update radio button styling
            document.querySelectorAll('.radio-option').forEach(option => {
                const radio = option.querySelector('input[type="radio"]');
                if (radio.checked) {
                    option.style.borderColor = 'var(--green-primary)';
                    option.style.backgroundColor = 'var(--green-50)';
                } else {
                    option.style.borderColor = 'var(--gray-200)';
                    option.style.backgroundColor = 'white';
                }
            });
            
            if (fileRadio.checked) {
                fileContainer.style.display = 'flex';
                urlContainer.style.display = 'none';
                fileInput.required = true;
                urlInput.required = false;
            } else if (urlRadio.checked) {
                fileContainer.style.display = 'none';
                urlContainer.style.display = 'flex';
                fileInput.required = false;
                urlInput.required = true;
            }
        }

        // Function to notify game of background changes
        function notifyBackgroundChange() {
            // Trigger custom event to update game background options
            try {
                if (window.parent && window.parent !== window) {
                    // If in iframe, notify parent
                    window.parent.postMessage({ type: 'backgroundsUpdated' }, '*');
                } else {
                    // Update localStorage trigger for game to reload backgrounds
                    localStorage.setItem('fifteenPuzzleBackgroundsLastUpdate', Date.now().toString());
                }
            } catch (error) {
                console.log('Could not notify background change:', error);
            }
        }
    </script>
</body>
</html>
